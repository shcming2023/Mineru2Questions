# 数学题目提取器 - 项目TODO

## 核心功能
- [x] 数据库schema设计(任务表、配置表、结果表)
- [x] MinerU文件夹上传和解析功能
- [x] LLM API配置界面(URL、密钥、模型、并发数)
- [x] 批量任务队列管理
- [x] 任务状态跟踪(pending/processing/completed/failed/paused)
- [x] 实时进度显示(当前页面、完成数、预计时间)
- [x] 题目提取核心逻辑(VLM分析页面图片)
- [x] JSON格式结果预览
- [x] Markdown格式结果预览
- [x] 结果下载功能(题目+图片+markdown)
- [x] 错误处理和重试机制
- [x] 处理历史记录查看
- [x] 任务暂停和恢复功能

## 界面设计
- [x] Dashboard布局(侧边栏导航)
- [x] 任务列表页面
- [x] 新建任务页面(文件上传)
- [x] API配置页面
- [x] 任务详情页面(进度+结果)
- [x] 历史记录页面

## 测试
- [x] 单元测试(vitest)
- [x] 界面功能测试
- [x] API接口测试

## API连接测试功能
- [x] 后端API测试接口实现
- [x] 前端测试按钮和状态反馈
- [x] 测试结果展示(成功/失败/错误信息)

## 基于DataFlow论文的优化改进
- [x] 重构提取逻辑:采用ID-based提取方式
- [x] 实现MinerU content_list.json解析和格式转换
- [x] 优化提示词:参考QAExtractPrompt设计
- [x] 实现章节标题提取和题号规范化
- [x] 支持问题-答案分离的教材匹配
- [x] 完善图片关联机制
- [x] 添加输出格式:JSON + Markdown
- [x] 同步代码到GitHub仓库

## 基于独立评审的优化改进
- [x] A. 切片边界问题: 增加Overlap重叠窗口避免题目被切断
- [x] B. 公式ID连续性检测: 通过提示词优化强调连续 ID的重要性
- [x] C. 多文件支持: mergeQAPairs已支持独立的questions和answers列表
- [x] 交叉验证官方实现的具体细节

## 端到端测试 - 新思路八下数学教材
- [x] 获取samples文件夹中的测试数据
- [x] 分析新思路八下教材和答案的数据结构
- [x] 编写端到端测试脚本
- [x] 验证代码逻辑与官方实现完全一致
- [x] 确认ID和索引映射正确
- [ ] 使用真实LLM API进行完整测试(需用户配置)
- [x] 同步到GitHub

## 基于用户分析的鲁棒性优化 (2026-02-05)
- [x] 问题1: 增强题号解析,支持复合题号(1.1, 1.2等)避免Hash冲突
- [x] 问题2: 改用"择优保留"策略处理Overlap重复,保留更完整的版本
- [x] 问题3: 智能文本拼接,行内公式用空格连接而非换行
- [x] 更新单元测试验证修复效果
- [x] 同步到GitHub仓库

## 任务日志优化和页数限制修复 (2026-02-05)
- [x] 检查并移除页数限制,支持完整教材处理
- [x] 优化任务日志系统,记录详细的处理步骤
- [x] 添加当前处理chunk/总chunk数的进度信息
- [x] 记录每个chunk的处理结果(成功/失败/提取数量)
- [x] 添加错误详情日志便于问题排查
- [x] 测试验证并同步到GitHub

## AI API供应商预设配置 (2026-02-05)
- [x] 添加常见AI API供应商预设(硅基流动、阿里云百炼、OpenAI、Azure、Gemini、Claude、智谱、月之暗面)
- [x] 更新前端配置界面支持预设选择
- [x] 用户只需填写API Key即可完成配置
- [x] 优化任务详情页面显示详细处理日志
- [x] 测试验证并同步到GitHub

## 并发处理优化 (2026-02-05)
- [x] 将串行for循环改为并发Promise池处理
- [x] 使用maxWorkers参数控制并发数
- [x] 保持结果顺序正确
- [x] 单个chunk失败不影响其他chunk
- [x] 并发下准确显示进度
- [x] 测试验证并同步到GitHub

## 测试案例输出分析 (2026-02-06)
- [x] 拉取最新代码并查看测试案例输出
- [x] 分析案例1: 202602052049-1770295769507 (22个题目,label错乱)
- [x] 分析案例2: 202602052053-1770296016866 (429个题号只输出8个!)
- [x] 对比输入内容与输出结果,找出不完整原因
- [x] 定位根因: normalizeTitle过度简化导致Key冲突
- [x] 修复1: 改进 normalizeTitle 保留更多上下文
- [x] 修复2: 使用 questionIds 作为主键去重
- [x] 修复3: 使用章节计数器避免不同章节的相同题号冲突
- [x] 单元测试通过 (33/33)
- [x] 同步到GitHub

## 任务日志详细输出优化 (2026-02-06)
- [x] 分析当前日志系统实现
- [x] 增加页面/chunk处理进度日志 (ID范围, 估计页码)
- [x] 增加题目提取数量统计日志 (题号列表)
- [x] 增加答案匹配情况日志 (匹配率统计)
- [x] 增加图片关联情况日志 (关联率, 图片数)
- [x] 同步到GitHub

## 测试任务202602060949分析 (2026-02-06)
- [x] 拉取最新代码并查看测试任务输出
- [x] 核查事实: 分析content_list结构和粒度 (2798块, 5个chunk)
- [x] 核查事实: 分析questions.json的问题 (15个题目包含22个①②③)
- [x] 定位根因: 提示词让LLM把①②③当作sub-questions
- [x] 修复1: 修改QA_EXTRACT_PROMPT明确①②③是独立题目
- [x] 修复2: 添加正确和错误示例对比
- [x] 单元测试通过 (33/33)
- [x] 同步到GitHub

## 对比官方DataFlow仓库实现 (2026-02-06)
- [x] 阅读官方DataFlow仓库的QA提取提示词 (pdf2vqa.py)
- [x] 阅读官方DataFlow仓库的处理逻辑 (llm_output_parser.py, qa_merger.py, format_utils.py)
- [x] 对比当前项目与官方实现的差异
  - 官方使用 re.search(r'\d+') 提取label数字
  - 官方没有处理①②③圆圈数字!
  - 当前项目需要补充这个功能
- [x] 根据官方实现修正当前项目
  - 添加 convertCircledNumbers 函数
  - 修改 normalizeLabel 支持①②③
  - 修改 getLabelKey 支持①②③
- [x] 单元测试通过 (39/39)
- [x] 同步到GitHub

## 测试任务202602061048分析 (2026-02-06)
- [x] 拉取最新代码并查看测试任务输出 (10个题目, 无答案)
- [x] 核查独立分析报告的各项观点
  - [x] 问题2: mergeQAPairs的Key设计问题 - 确认是Bug, 已修复
  - [x] 问题3: parseLLMOutput正则无法处理多行 - 确认是Bug, 已修复
  - [x] 问题4: convertMinerUContentList丢失page_idx - 确认, 影响有限
  - [x] 问题1: Overlap分块ID映射问题 - 部分正确, 不是主因
  - [ ] 问题5: LLM调用缺少retry和限流 - 待修复
  - [ ] 问题6: idsToText的LLM输出文本检测 - 待修复
  - [ ] 问题7: db文件被提交到仓库 - 待处理
- [x] 定位根因并实现修复
  - [x] 修复正则: (.*?) -> ([\s\S]*?)
  - [x] 重写mergeQAPairs: 两阶段匹配策略(精确+模糊)
- [x] 单元测试通过 (39/39)
- [ ] 同步到GitHub
