# PRD v4.0 代码对齐修复 - 验证测试计划

**测试日期**: 2026-02-21  
**测试基准**: PRD v4.0 + 代码对齐修复报告  
**服务地址**: http://localhost:3000  
**测试执行人**: 开发团队

---

## 📋 验证清单总览

| 序号 | 测试场景 | 优先级 | 预计耗时 | 状态 |
|------|---------|--------|---------|------|
| 1 | 服务启动验证 | P0 | 5分钟 | ✅ 已完成 |
| 2 | 正常章节预处理流程验证 | P0 | 15分钟 | ⏳ 待执行 |
| 3 | 章节预处理失败场景验证 | P0 | 10分钟 | ⏳ 待执行 |
| 4 | ChapterMerge策略验证 | P1 | 15分钟 | ⏳ 待执行 |
| 5 | 端到端回归测试 | P1 | 30分钟 | ⏳ 待执行 |

**预计总耗时**: 1小时15分钟

---

## ✅ 测试1: 服务启动验证

### 测试目标
验证代码修改后服务能正常启动，无编译错误和运行时错误。

### 验证步骤
1. ✅ 启动开发服务 (`npm run dev`)
2. ✅ 检查服务端口监听状态 (3000端口)
3. ⏳ 访问前端页面
4. ⏳ 检查控制台无严重错误

### 预期结果
- [x] 服务在3000端口正常监听
- [ ] 前端页面可访问
- [ ] 控制台无TypeScript/运行时错误
- [ ] 数据库连接正常

### 实际结果
- ✅ 服务已启动在端口 3000
- 待验证：前端页面访问

---

## ⏳ 测试2: 正常章节预处理流程验证

### 测试目标
验证修复后的 `preprocessChapters` 函数能正常调用，且产出符合PRD v4.0要求。

### 测试前提
- 需要一个已配置的长上下文LLM（如DeepSeek/Gemini）
- 需要一个MinerU解析过的测试文件（如Task 1或Task 2）

### 验证步骤

#### A. 通过前端UI测试
1. 访问 http://localhost:3000
2. 进入"设置"页面，确认章节预处理LLM已配置
3. 创建新任务：
   - 任务名称：`章节预处理回归测试-正常流程`
   - 上传：使用已有的测试文件
   - 选择：章节预处理LLM + 题目抽取LLM
4. 观察任务详情页日志输出

#### B. 关键验证点
- [ ] 日志显示"开始章节预处理（零筛选全文推理 + 两轮 LLM 校验）"
- [ ] **不再显示**"自适应三轨混合架构"字样
- [ ] 日志显示"章节预处理完成: X 个章节条目, 覆盖率 Y%"
- [ ] `debug/chapter_flat_map.json` 文件生成
- [ ] 任务状态变为 `completed`

#### C. 数据质量检查
```bash
# 检查章节预处理输出文件
cd server/uploads/tasks/<taskId>/debug/
cat chapter_flat_map.json | jq length
cat chapter_flat_map.json | jq '.[0]'
```

### 预期结果
- [ ] 章节预处理使用 `preprocessChapters` 而非 `preprocessChaptersV2`
- [ ] 日志描述对齐PRD v4.0
- [ ] 生成有效的 `chapter_flat_map.json`
- [ ] 覆盖率 > 90%（取决于测试文件）

### 实际结果
待执行后填写

---

## ⏳ 测试3: 章节预处理失败场景验证（核心修复验证）

### 测试目标
验证P0-002修复：章节预处理失败时任务直接失败，**不再降级**。

### 测试方案选择

#### 方案A: 配置错误的章节预处理LLM（推荐）
**步骤**：
1. 进入"设置"页面
2. 创建一个新的章节预处理LLM配置：
   - 名称：`测试-故意失败LLM`
   - API URL：`https://api.example.com/v1`（不存在的地址）
   - API Key：`invalid-key`
   - 模型：`test-model`
   - 用途：`长文本推理`
3. 创建新任务，选择这个错误的LLM配置
4. 启动任务

#### 方案B: 使用超长文档触发上下文超限
**步骤**：
1. 准备一个超大文件（> 200页）
2. 使用上下文窗口较小的模型（如8k上下文）
3. 触发 Token 超限错误

### 关键验证点

#### 修复前的行为（需确认已不存在）
```
❌ 错误行为（修复前）：
1. 日志显示 [WARN] "章节预处理失败（将降级使用题目抽取阶段的章节信息）"
2. chapterResult = null
3. 任务继续执行题目抽取阶段
4. 最终任务状态 = completed（但题目无章节信息）
```

#### 修复后的预期行为
```
✅ 正确行为（修复后）：
1. 日志显示 [ERROR] "章节预处理失败，任务终止: <错误信息>"
2. 抛出异常 throw new Error(...)
3. 任务不会进入题目抽取阶段
4. 最终任务状态 = failed
```

### 验证步骤
1. [ ] 按方案A配置错误LLM并启动任务
2. [ ] 观察任务详情页日志输出
3. [ ] 确认任务状态变为 `failed`
4. [ ] 检查日志中**不存在**"降级"字样
5. [ ] 检查日志中包含"任务终止"字样
6. [ ] 确认未生成 `results/questions.json`

### 预期结果
- [ ] 任务状态 = `failed`（不是completed）
- [ ] 错误日志级别 = `ERROR`（不是WARN）
- [ ] 日志包含"任务终止"而非"降级"
- [ ] 未产生无章节信息的结果文件

### 实际结果
待执行后填写

---

## ⏳ 测试4: ChapterMerge策略验证（P1-002修复）

### 测试目标
验证章节融合的fallback策略已修正为"预处理优先"。

### 测试场景
需要制造一个场景：`preIsValid && llmIsValid` 且两者都不匹配结构模式。

### 验证方法

#### 方法A: 代码审查（简单快速）
```bash
# 检查代码是否已修正
grep -A 5 "PRD v4.0: 预处理结果优先" server/extraction.ts
```

#### 方法B: 实际数据验证（更可靠）
1. 运行一个包含章节预处理的完整任务
2. 提取结果中找一道题目，检查其章节来源
3. 对比 `debug/chapter_flat_map.json` 和最终 `questions.json`

```bash
# 示例检查命令
cd server/uploads/tasks/<taskId>/
jq '.[] | select(.label == "1") | {chapter_title, chapterSource, questionIds}' results/questions.json
```

### 预期结果
- [ ] 代码中fallback为 `preTitle`（不是 `llmTitle`）
- [ ] 实际数据中优先使用预处理结果
- [ ] 注释包含"PRD v4.0: 预处理结果优先"

### 实际结果
待执行后填写

---

## ⏳ 测试5: 端到端回归测试

### 测试目标
确保修复未引入新的回归问题，整个流水线能正常工作。

### 测试数据
使用历史测试文件：
- Task 1: 高一数学（已知baseline: 800+题）
- Task 2: 其他学科测试文件

### 验证步骤
1. [ ] 配置有效的章节预处理LLM和题目抽取LLM
2. [ ] 创建新任务并上传Task 1文件
3. [ ] 等待任务完成（预计10-15分钟）
4. [ ] 对比结果：
   - 题目总数与历史baseline接近（±5%）
   - 章节覆盖率 > 99%
   - 无严重错误日志
5. [ ] 检查输出文件质量：
   ```bash
   cd server/uploads/tasks/<taskId>/results/
   jq 'length' questions.json
   jq '[.[] | .chapter_title] | unique | length' questions.json
   head -100 questions.md
   ```

### 预期结果
- [ ] 任务成功完成（状态=completed）
- [ ] 题目数量与历史baseline相近
- [ ] 章节覆盖率 > 99%
- [ ] Markdown输出格式正确
- [ ] 无新增严重错误

### 实际结果
待执行后填写

---

## 📊 综合评估标准

### 测试通过标准
| 测试项 | 通过条件 |
|--------|---------|
| 测试1 | 服务正常启动，前端可访问 |
| 测试2 | 章节预处理调用正确函数，输出有效 |
| 测试3 | 失败时任务状态=failed，不降级 |
| 测试4 | 代码逻辑修正为预处理优先 |
| 测试5 | 端到端流程无回归，质量指标达标 |

### 发布决策矩阵
| 测试结果 | 决策 |
|---------|------|
| 测试1-3全部通过 + 测试4通过 | ✅ **可以发布**（测试5可后续补充） |
| 测试1-3全部通过 + 测试4失败 | ⚠️ **修复P1-002后发布** |
| 测试3失败 | 🔴 **不可发布**（P0问题未解决） |
| 测试1-2失败 | 🔴 **回滚修改，重新调试** |

---

## 🐛 问题记录模板

### 发现问题时填写

**问题编号**: BUG-001  
**发现时间**: YYYY-MM-DD HH:mm  
**测试场景**: 测试X - XXX  
**严重程度**: P0 / P1 / P2  

**问题描述**:
（详细描述观察到的异常行为）

**预期行为**:
（PRD要求的正确行为）

**实际行为**:
（实际发生的情况）

**复现步骤**:
1. 步骤1
2. 步骤2
3. ...

**日志截取**:
```
（相关错误日志）
```

**初步分析**:
（可能的原因）

**处理建议**:
（修复方案或回滚建议）

---

## 📝 测试执行记录

### 执行人签名
- **执行人**: ___________
- **开始时间**: 2026-02-21 ____:____
- **结束时间**: 2026-02-21 ____:____
- **总耗时**: _____ 分钟

### 测试结论
- [ ] ✅ 全部测试通过，可以发布
- [ ] ⚠️ 部分测试通过，需补充修复
- [ ] 🔴 测试失败，需回滚代码

### 备注
（其他需要记录的信息）

---

**文档状态**: 🟡 测试进行中  
**最后更新**: 2026-02-21
