# 评审快速指南

**目标**: 验证 PRD v4.0 代码对齐修复的有效性  
**评审基准**: `Mineru2Questions_PRD_v4.0.md`  
**提交**: `5513bd5` (代码修复) + `2c9937c` (测试数据)

---

## 🎯 3分钟快速评审

### 1️⃣ 验证P0-001修复（30秒）
```bash
# 检查是否还在调用废弃的V2
grep -n "preprocessChaptersV2" server/taskProcessor.ts
# 应该返回空（无匹配）

# 检查是否已替换为新函数
grep -n "preprocessChapters" server/taskProcessor.ts
# 应该看到导入和调用
```

**预期**: ❌ 无V2调用 ✅ 有新函数调用

---

### 2️⃣ 验证P0-002修复（1分钟）
```bash
# 检查taskProcessor中的失败处理
grep -A 5 "Chapter preprocess failed" server/taskProcessor.ts
# 应该看到 throw new Error，而非 chapterResult = null

# 检查chapterPreprocess中的失败处理
grep -A 2 "第一轮章节抽取失败" server/chapterPreprocess.ts
# 应该看到 throw new Error

grep -A 2 "章节验证失败" server/chapterPreprocess.ts
# 应该看到 throw new Error
```

**预期**: ✅ 所有失败场景都抛出异常（不返回null或空数组）

---

### 3️⃣ 验证P1修复（1分钟）
```bash
# P1-001: 检查validateChapterEntries是否导出
grep -n "export function validateChapterEntries" server/chapterPreprocess.ts
# 应该在第699行左右

# P1-002: 检查ChapterMerge的fallback
grep -A 3 "PRD v4.0: 预处理结果优先" server/extraction.ts
# 应该看到 q.chapter_title = preTitle as string
```

**预期**: ✅ 函数已导出 ✅ fallback改为preTitle

---

## 📊 10分钟深度评审

### 1️⃣ 查看测试数据（5分钟）

```bash
# 进入测试任务目录
cd server/uploads/tasks/202602210937-1771637877756

# 查看章节预处理结果
cat debug/chapter_flat_map.json | jq '.[] | {title, level, start_idx, end_idx}' | head -30

# 查看第一轮LLM抽取结果
cat debug/chapter_llm_round1_attempt1.json | jq '.entries | length'

# 查看第二轮校验结果
cat debug/chapter_llm_round2_attempt1.json | jq '.changes | length'

# 查看题目抽取结果
cat results/questions.json | jq '. | length'
```

**评审要点**:
- ✅ `chapter_flat_map.json` 不应为空数组
- ✅ 章节标题应有层级结构
- ✅ 题目应有 `chapter_title` 字段且非空

---

### 2️⃣ 阅读修复报告（5分钟）

**位置**: `docs/PRD_v4.0_代码对齐修复报告_2026-02-21.md`

**重点章节**:
1. **根因分析** (第34-85行)
   - 是否真正找到系统性根因？
   - 5层Why分析是否深入？

2. **修复措施** (第88-210行)
   - 修改范围是否最小化？
   - 是否有潜在副作用？

3. **验证结果** (第315-340行)
   - 所有验证项是否通过？
   - 是否有遗漏的测试场景？

---

## 🧪 完整功能验证（30分钟）

如果需要亲自验证修复效果：

### 启动服务
```bash
./start_server.sh
# 等待服务完全启动（约10秒）
```

### 测试场景1：正常流程
1. 访问 http://localhost:3000
2. 配置有效的长上下文LLM
3. 上传测试PDF
4. 观察任务完成，章节信息正确

### 测试场景2：失败不降级（核心）
1. 添加错误LLM配置：
   ```
   名称: 评审测试-失败LLM
   API URL: https://invalid.example.com/v1
   API Key: test-key
   模型: test-model
   用途: 长文本推理
   ```
2. 创建新任务，选择该错误LLM作为章节预处理模型
3. **验证点**:
   - ❌ 任务状态应为 `failed`
   - ❌ 日志应包含"任务终止"
   - ✅ 日志不应包含"降级"

### 测试场景3：API验证
```bash
# 运行API测试脚本
./api_test_p0.sh

# 查看任务列表
curl http://localhost:3000/api/trpc/task.list | jq
```

---

## ✅ 评审通过标准

### 必须项 (所有通过才能接受)
- [ ] P0-001: 代码中无 `preprocessChaptersV2` 调用
- [ ] P0-002: 失败场景全部抛出异常（不降级）
- [ ] P1-001: `validateChapterEntries` 已导出
- [ ] P1-002: ChapterMerge fallback 为 `preTitle`
- [ ] 测试数据完整（2个任务，包含debug信息）
- [ ] 文档齐全（修复报告、测试计划）

### 建议项 (可延后处理)
- [ ] P1-003: 提取 `processChunk` 函数
- [ ] P2系列: 代码清理和优化
- [ ] 端到端回归测试（5+个PDF）

---

## 🚨 评审发现问题的处理流程

### 如果发现P0问题
1. 立即在GitHub创建 **Critical Issue**
2. 标记为 `P0-Blocker`
3. 通知项目维护者
4. 暂停发布，优先修复

### 如果发现P1/P2问题
1. 在GitHub创建 **Issue**，标记优先级
2. 评估是否阻塞发布
3. 如不阻塞，纳入下一Sprint

### 如果测试数据有问题
1. 检查是否影响评审判断
2. 如影响，要求补充完整测试数据
3. 更新测试验证清单

---

## 📋 评审检查清单（打印版）

```
□ 代码修复
  □ P0-001: 废弃V2已移除
  □ P0-002: 失败场景不降级
  □ P1-001: 验证函数已导出
  □ P1-002: 融合策略已修正

□ 测试数据
  □ 任务数量: 2个
  □ 包含debug信息
  □ 包含完整日志
  □ 章节预处理结果完整

□ 文档质量
  □ 修复报告完整
  □ 根因分析深入
  □ 测试计划可执行
  □ 验证结果清晰

□ Git质量
  □ Commit message规范
  □ 文件变更合理
  □ 无意外的删除
  □ 提交历史清晰
```

---

## 🎓 评审学习价值

本次修复展示了：
1. **根因分析方法**: 5层Why挖掘系统性问题
2. **最小修改原则**: 精准修复，避免重构
3. **失败语义设计**: 何时降级、何时终止
4. **测试数据价值**: 完整的debug信息支持评审

建议作为团队案例学习。

---

**评审时间**: 建议3-30分钟（根据深度选择）  
**评审人**: ___________  
**评审日期**: ___________  
**评审结论**: □ 通过 □ 有条件通过 □ 不通过
