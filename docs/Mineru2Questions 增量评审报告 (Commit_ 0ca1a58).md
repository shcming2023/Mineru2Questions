# Mineru2Questions 增量评审报告 (Commit: 0ca1a58)

**版本**: 1.1
**日期**: 2026-02-13
**作者**: Manus AI

## 1. 评审范围

本次评审覆盖了自 `58ac708` 之后的所有变更，核心包括：

- **代码修复**: `routers.ts` 的 API URL 处理、`chapterPreprocess.ts` 的模型兼容性增强。
- **新增工具**: `server/scripts/debug-llm.ts` 诊断脚本。
- **测试任务数据**: `server/uploads/tasks/202602131041...` (大型英文数学教材)。

## 2. 代码修复评审

| 文件 | 变更内容 | 评审结果 |
|---|---|---|
| `server/routers.ts` | 增强 API URL 处理逻辑，兼容带或不带 `/chat/completions` 后缀的 URL。 | ✅ **通过**。这是一个很好的鲁棒性增强，能减少用户配置错误。 |
| `server/chapterPreprocess.ts` | 移除了 `response_format: { type: 'json_object' }` 参数。 | ✅ **通过**。这提升了对不严格支持此参数的 LLM (如 Qwen-VL) 的兼容性。配合已有的 JSON 提取容错逻辑，是合理的权衡。 |
| `server/scripts/debug-llm.ts` | 新增了用于诊断 LLM 连接问题的独立脚本。 | ✅ **强烈推荐**。这个脚本非常实用，能快速定位是 API Key、URL、模型名称还是网络问题，极大提升了可维护性。 |

## 3. 测试任务数据分析 (`202602131041...`)

这是一个高质量的大型英文数学教材样本（891 页，3610 道题），为我们提供了宝贵的分析数据。核心发现如下：

| 分析项 | 结果 | 结论与建议 |
|---|---|---|
| **章节预处理** | **未运行** (`chapter_flat_map.json` 不存在) | 任务创建时未指定 `chapterConfigId`。导致章节标题由题目抽取 LLM 自行判断，质量不高（大量数字标题如 `6.2`, `10.4`）。**建议**：后续所有任务都应配置 `chapterConfigId` 以启用 v9.1 流程。 |
| **ID-Only 合规性** | **100% 通过** | 所有 3610 个题目都严格遵守了 ID-Only 格式，`questionIds` 字段中没有自由文本。这是流水线成功的关键。 |
| **去重效果** | **部分有效** (214 对重叠) | 旧的去重逻辑 (`> 0.5`) 未能合并 Jaccard 系数恰好等于 0.5 的 25 对重复题目。**已修复**：我们将阈值改为 `>= 0.5` 并已提交代码。 |
| **图片路径** | **100% 相对路径** | `images` 数组和 `question` 文本中的图片路径均为相对路径，符合预期。 |
| **LLM 空输出** | **43/351 (12%)** | 12% 的 chunk 返回了 `<empty>`，说明这些 chunk 中没有 LLM 认为的题目。这在教材的非习题部分是正常现象。 |

## 4. 结论与后续步骤

本次增量更新质量很高，代码修复和新增的诊断工具都非常有价值。测试任务数据暴露了去重逻辑的边界问题，并再次验证了启用章节预处理的必要性。

**最终结论**：项目状态健康，核心流水线符合 DataFlow 最佳实践。建议将 Jaccard 阈值修复 (`>= 0.5`) 合并到主流程，并确保所有新任务都启用章节预处理。

**后续建议**：
1.  **合并 Jaccard 修复**：`fix(dedup): Jaccard threshold >= 0.5` (commit `3f59c35`) 已推送到 `main` 分支。
2.  **强制启用章节预处理**：在创建任务时，将 `chapterConfigId` 设为必填项，或提供一个可靠的默认长文本模型配置。
3.  **归档本次评审**：本次评审已完成，可以关闭相关 issue 关闭。
