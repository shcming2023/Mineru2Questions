# 故障分析与恢复报告

**报告日期**: 2026-02-09
**执行人**: 资深架构师 (TraeAI)
**状态**: ✅ 已恢复

## 1. 故障摘要
用户报告系统无法访问、配置功能失效及疑似历史数据丢失。经诊断，主要原因为**开发服务器进程冲突**导致端口资源争夺，以及**代码属性映射错误**导致配置读取失败。

## 2. 系统状态诊断

### 2.1 故障现象
- **无法访问**: 服务端口拒绝连接 (Connection Refused)。
- **配置失效**: 任务启动时报错 "LLM config not found"。
- **数据丢失**: 前端页面无法加载历史任务列表（因 API 服务异常）。

### 2.2 根因分析
1.  **进程冲突 (Critical)**: 检测到 3 个并发的 `pnpm run dev` 进程 (PID 对应 Terminal 3, 4, 5) 争抢系统资源，导致服务端口无法正常绑定。
2.  **代码缺陷 (Major)**: 
    - `server/taskProcessor.ts` 中存在属性命名风格不一致 (`snake_case` vs `camelCase`)，导致读取数据库配置时返回 undefined。
    - `server/extraction.ts` 中的 `splitIntoChunks` 函数存在逻辑漏洞，在特定条件下（剩余块数 < 窗口重叠数）会触发无限循环，导致内存耗尽 (OOM) 并使服务崩溃。
3.  **环境干扰**: 多个残留进程导致数据库文件锁竞争，可能引发短暂的读取失败。

## 3. 恢复执行记录

### 3.1 紧急恢复流程
1.  **终止冲突进程**: 强制停止所有异常的开发服务器进程 (Terminals 3, 4, 5)。
2.  **代码热修复**: 
    - 修正 `splitIntoChunks` 的循环终止条件，防止死循环。
    - 优化 `package.json` 启动参数，增加 Node.js 堆内存限制至 4GB (`--max-old-space-size=4096`) 以增强抗压能力。
3.  **数据库完整性检查**: 
    - 验证 `sqlite.db` 文件存在且路径正确。
    - 确认数据库模式 (`drizzle/schema.ts`) 与代码定义一致。
3.  **单实例重启**: 在洁净环境中重启服务，服务成功绑定至 **Port 3000**。
4.  **服务验证**:
    - `HTTP GET /` (Health Check): **200 OK** (返回应用首页 HTML)。
    - API 连通性测试: 正常。

### 3.2 功能修复
- 修正 `taskProcessor.ts` 中的属性访问逻辑，确保 LLM 配置能被正确读取。
- 移除 `routers.ts` 中过时的任务控制接口调用，消除运行时错误日志。
- 增加任务进度实时上报机制，解决任务"假死"现象。

## 4. 历史数据核查
- **结论**: **数据未丢失**。
- **说明**: 用户观察到的"数据丢失"实为服务不可用导致的 UI 加载失败。服务恢复后，历史数据 (`extraction_tasks`, `llm_configs`) 可正常读取。

## 5. 预防措施与优化建议

### 5.1 短期措施 (立即实施)
- **启动脚本优化**: 修改 `package.json` 中的启动脚本，增加 `kill-port` 预处理，防止端口占用。
- **错误捕获增强**: 在 API 层增加更友好的错误提示，区分"网络错误"与"数据为空"。

### 5.2 长期优化建议
1.  **自动化运维**: 部署 PM2 或 Docker 容器化管理，确保单一服务实例运行，具备自动重启与日志轮转功能。
2.  **健康监控**: 集成 Uptime Kuma 或类似工具，实时监控端口 3000/3006 响应状态。
3.  **数据库备份**: 建立每日定时备份机制 (Crontab + S3)，保留最近 7 天的 `sqlite.db` 快照。
4.  **类型安全强化**: 引入全链路类型检查 (End-to-End Type Safety)，确保数据库 Schema 与业务代码严格一致，避免属性名拼写错误。

---

**当前服务访问地址**: http://localhost:3000
